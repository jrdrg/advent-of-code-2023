import util
import functools

example_input = """
...#......
.......#..
#.........
..........
......#...
.#........
.........#
..........
.......#..
#...#.....
"""

input_str = """
........................#...............................................#................................#................................#.
....#..............#......................#............#....................................................................#...............
................................#.............................................................#.............................................
.........#.....................................#...................#........................................................................
....................................................#.......................#..............................#................................
..#................................................................................................#................#......................#
.........................................................#.........................#.....#..................................................
..................................#.............................#...............................................#.............#.............
.......#.....#...........................#..............................................................#.............................#.....
......................#...............................#................................................................#....................
............................#.................#........................#.....................................#..............................
....#.................................#...............................................#.....................................................
...............#...........................................................#............................................................#...
..................................#...........................................................#...................#...........#.............
....................................................................................................................................#.......
................................................................#................#..........................#...............................
...#..............#........#.........#.............#........................................................................................
.........................................................#.............#.............#..............#...................#...................
........#...................................................................................................................................
..............................................................................................#.................................#........#..
....................#.......................................#.....................................................#.........................
#..............................#.......#......#...................................#......#..................................................
...........#.......................................#......................................................................#.................
.......................................................................................................................................#....
............................................................................................................................................
.........................#...................................#...............................#..............................................
..................................#.......................................................................#.............#...................
.........................................#...........................#...............................#.........#..........................#.
............#......#............................................#...............................#...................................#.......
.............................#.....................................................#........................................................
....#........................................#...............................#.................................................#............
......................#............................#.....#.........#........................................................................
.........................................................................................................#..................................
.......#........................#................................................#..........................................................
...............................................#..........................#................#..........................................#.....
.#................#.............................................................................................#......#....................
..............................................................................................................................#.............
..........................#........................#.............................................#..........................................
.............#..........................#............................................#..............................#.......................
........#..............................................#.....................#..........................#..................#................
............................................................#.....#..................................................................#......
....................#.........................#..........................#..................#...................#...........................
..............................#...................................................#................#........................................
.........................................#..............................................#..................................................#
.#........#.........................................#.....................................................#.....................#...........
.........................................................#.........................................................#........................
......#...........................#.........................................................................................................
................................................#........................................................................................#..
...................................................................#...............#........................................................
.....................#................................#..............................................................................#......
...........#................................................................................#.....#.........................................
....#........................#............................................#..............................................#..................
................#.......#........................................................#........................................................#.
#...................................................................................................................#.......................
....................#...................#..............#.................................#...................#..............................
.............#....................#.................................................#..................#...................#................
.................................................................................................................#.....................#....
................................................................................#...........................................................
.......................#.............#....................#.................................................................................
.......#.............................................................................................#..............#.......................
...................#.....................................................................................................................#..
......................................................#..................#.......................................................#..........
..........................#..................................................................#..............................................
............#.................................#.........................................#...................#............#..................
.....................#......................................#......................................................#..........#.............
.#.........................................................................#......#...................#.....................................
............................................................................................................................................
................................#...........................................................#...............................................
........................................#..........................#..................................................#.................#...
....#........................................#.....................................................#.............................#..........
..........................................................#.................................................................................
...............#............................................................................................................................
..........#............#............................#.............................#...........................................#......#......
....................................#........................................................#...............#..............................
...........................................#..............................#...............................................................#.
.#...........................#.......................................................................#......................................
.........................................................#...........#....................................#.................................
......#.......#...................#...........................#.......................#.........#..................#........................
............................................................................#.........................................................#.....
.....................#.........................................................................................#........#...................
..........................#.............................................#................#........................................#.........
............................................................................................................................................
....#.....#.....#..................................#.........#.....................#....................#...................................
........................................#.....................................................................................#.............
...............................................................................................#............................................
.......#........................#...........................................#............................................................#..
....................#......#....................#...........................................................................................
.........................................................#...........#..........#.............................#...........#.................
......................................................................................#.....................................................
....................................................................................................#................#..........#.....#.....
............#.........#.....................#...............#..............................................#................................
.......#............................#.......................................................................................................
.......................................................................#......................#................#...................#........
............................................................................................................................................
........................................................................................................................#...................
..........#..........#.......................#.........................................................................................#....
...................................................................#.................#...........#..........................................
........................................#................#..................................................................................
................#....................................................................................................#......................
............................................................................................................................................
.......#....................#.................................................................#...............#.........................#...
.................................#...........#.....#...........................................................................#............
...........#.......................................................#....................#...................................................
........................................#...............................................................................#...................
............................................................................................................................................
.....................................................................................................#......................................
................#.........................................#..................#................................................#.......#.....
....#................................#.............#...................................#.....................#.......#......................
.........................#......................................#...........................................................................
...........................................................................................#.......#........................................
..........#.....................#..............#........................#...................................................................
..#.........................................................................................................................................
....................#.....................................#.......................#.........................................................
..........................#.............#...............................................................................#.........#.........
......................................................................................#.....................................................
.....................................................................#..........................#...........................................
.......#.........#...........................................................#.......................#........#............#............#...
........................#....................................#..............................................................................
.......................................#............................................#....................#.........................#........
..............................................#....................................................................#........................
..............#..................#.....................................#..........................#.........................................
..........................................#..........#..........................#...........................................................
.....#......................................................................................#................#..............................
.....................#................................................................#.......................................#.............
.....................................................................#......................................................................
...........#.....#............................#.....................................................................................#.......
................................#.....#..........................#........#..........................................#....................#.
...........................#.................................................................#........#.......#.............................
#...........................................................................................................................................
........#........................................#...................................#......................................................
.............................................................................................................................#..............
.................................#..............................#........................#.........#........#...............................
............#.....#..........................#.......................#....................................................................#.
........................#........................................................#..........................................................
............................................................#..............#......................................#.........................
...#........................................................................................#...............................................
...........................................................................................................#......................#.........
..........#.......................................................................................#.........................................
......................#................#............................................#.................................................#.....
...........................#.....................#........#...................................................#.............................
"""

lines = util.get_lines(input_str)

def parse_input(lines: list[str]):
    coords = {}
    bounds = (len(lines), len(lines[0]))
    for y, line in enumerate(lines):
        for x, contents in enumerate(line):
            coords[(y, x)] = contents
    return (coords, bounds)


Galaxy = dict[tuple[int, int], str]
Pair = tuple[tuple[int, int], tuple[int, int]]

def expand_space(galaxy: Galaxy, bounds: tuple[int, int], expand_by: int = 1):
    empty_rows = set()
    empty_cols = set()
    h, w = bounds
    expanded_galaxy = {}
    for y in range(0, h):
        is_empty = True
        for x in range(0, w):
            if galaxy.get((y, x)) == "#":
                is_empty = False
        if is_empty:
            empty_rows.add(y)
    for x in range(0, w):
        is_empty = True
        for y in range(0, h):
            if galaxy.get((y, x)) == "#":
                is_empty = False
        if is_empty:
            empty_cols.add(x)

    def insert_row(y: int, y1: int):
        x1 = 0
        for x in range(0, w):
            if x in empty_cols:
                expanded_galaxy[(y1, x1)] = galaxy[(y, x)]
                x1 += expand_by
            expanded_galaxy[(y1, x1)] = galaxy[(y, x)]
            x1 += 1

    y1 = 0
    for y in range(0, h):
        if y in empty_rows:
            insert_row(y, y1)
            y1 += expand_by
        insert_row(y, y1)
        y1 += 1

    return expanded_galaxy


def find_galaxy_pairs(galaxy: Galaxy) -> list[Pair]:
    galaxy_coords = [coord for coord in galaxy if galaxy[coord] == "#"]
    pairs = []
    while len(galaxy_coords) > 1:
        cur = galaxy_coords.pop(0)
        cur_pairs = [(cur, p) for p in galaxy_coords]
        pairs.extend(cur_pairs) 
    return pairs

def shortest_path(pair: Pair):
    f, t = pair
    fy, fx = f
    ty, tx = t
    return abs(fy - ty) + abs(fx - tx)

def part1():
    (galaxy, bounds) = parse_input(lines)
    expanded = expand_space(galaxy, bounds)
    pairs = find_galaxy_pairs(expanded)
    shortest = [shortest_path(p) for p in pairs]
    return functools.reduce(util.add, shortest)

def part2():
    (galaxy, bounds) = parse_input(lines)
    expanded = expand_space(galaxy, bounds, 1000000 - 1)
    pairs = find_galaxy_pairs(expanded)
    shortest = [shortest_path(p) for p in pairs]
    return functools.reduce(util.add, shortest)


print("Part 1", part1())
print("Part 2", part2())
