import util
from enum import Enum

example_input = r"""
.|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|....
"""

input_str = r"""
\..|.....................|.-........\.............-................|./....|.....-...-.........................
.......\.........|..............-...||..............-...........--.|...............||..........\............|.
........../.....................\.........\..................\....|.....-.................../..-.\............
................/..../........../..-....|\.|...-...................\....|/........|...........................
.....|../-\.|....|................................--.-./..........|.........../..-....-................-....|.
.../..........\................-.......\................|/..\.................\.....\...|....../............./
..-../.../......-.....\........//.............|.........../...|.........../.......-...........................
......\....../......./..|\............/..........................\..............\.....\.........|......-...|..
.|/.......\.........|...../..//...................................-....-...........././-...............-......
........-....../......./..\.............|.....................\........../-....../........-...................
......-........./\..................../..\|..-//....|.\--................|.....|.../............-............\
........................|...-........|..............|..............|................./........................
...................|................|..../...-...................../...|......\..................|...|\.......
....-......../.\...............\-...\...........................................................|.............
.............../.|.......|.........\.\.........................-|.............\........-.../...-...||.........
....-...-\.-............/...../...../..\........\|....\...............\.............-........................\
........././.......//......-...|...........-...|..|....-......-.......|............................|../.......
\.................|..../.....-..|......./.....................\....../...|./\.\...............-............./.
.....-\............../...................................../....\.....-|...........-.\...../............\.....
......................./..\..................|...............-.........-..../......../..|.....................
....\...................../...../......|...........................\......||.\...-..............-...........|.
..........................|........../...........|....-.......\........................-|..\............/..|..
-./...|..............................................|./../.........-|.\.|..........\........../.........\....
...........|......................-............................|.........................\....-........../....
........................|/....\......../.|.......\.........../..................\........................-....
...../.................-............................-.\......|...............\...........\.....-.............-
....|-.............-.../....\...........-...........|\.............-.............../-....../..................
...............\/.............../.|............................/.|...................-............-...........
.................\.....\........./......../.....\.....|........-..\..........................|................
...............-..-........-........../...../...\.................\..-.-.....|..........\..............\......
.............-....../....|.\\............|......|.........-.......|................/.......|./............\...
.................................................\.......\-....\.........|.....-..|.........-................/
.............../..............\..........................\.................-\............-............-.......
/....|...../.....................................................-....\.....-................../..........-..\
.....\.....................-...........|...\.....-...../.......-.|.................|..........................
.............-..........-....-....-.-../....|.......-.\.........................-........../..../.....\.......
..........\\.........................../...-........./........\............|.........../......................
............-......|..................................................................-......./...-...........
........\............-......|....\............................\.\........|......................../......\...-
......../...|........|..-.-.../..../..........|........|....../....../../...........\.............\....../....
......|.........-........//........-../....\........./..........|.-......-...-......-.............\..|........
./......................../................-..........................................-.....--....|...........
....../............\\..../\............|..-.|.|.-.............-........|................................./.../
..-......../.......|.......|........................-....-..............................-.....................
.........||............|.\................|......................./.\...............-..........|..../..-..\...
\|.......|..\..........-.................../|.....-.............\............./....................../........
.....................|....-.../...............\.\.............................................................
............|.......................\...........-......|...././.-...../................|........-..........\.\
..........|../\.|.......|\..-............\.-..............-....../...\......||..\........-.\..../...\......./|
..|.....................................-\............//.......|..\..............\.........|....|.............
.....\...............................-........./..........\.........-....|..........-./../...\................
.....\./....-...\....................\|.........\.............-...\..........-...............|............./..
/./\......\.........\........-../......../.....|/..................../.././..-......................|\........
.|\...-.\\.......................|........-\.....|......|......./|..........-..../...................|.|......
...........\.............\./....|./.............................|.............................................
.../...../.|.................\...../.....-..............|.\.\../.................../.............\............
..............\............-........-........\....../............|....|...\....\...|.....-..../...............
/.\.\........-....\.|....-....\..../...-./...............-.......\../........./..../........./.......\........
|..............................-..\............................\......//........\../...-../..\......../.......
.............\.../.\............\--............|................-|............|......../......................
...../....|................................-.....................................|./..........|.........\.\\..
........./......-.....|............/.-.......\..-.......................................|..................\..
.......\.\.....................-|...../.....|........|............-..............-....../\..\....../..........
|..\.|........../|..\..|\..-...................\.................../.....-/...............|................../
...........|..-..............|........................-..............-...............-.............\.........\
...\./.....-...|.-.......-................/.\.....-..-...|......-.......................................--...|
...............-.........|............-............|./.......\...../.....\............-.\.....................
..................|......|..........-..............................-....|............|.\........./..-.........
|......................../.....-../|.....\./..\....|......................./........................./...\....
....|............-........\..-...............-................/\..........................|........|.......\-.
|......./.....\.......\..................-.\..../....|............|.../..................../|.../........../..
...-|..................||......--......\......|.............|\........./.................\......\........\....
./........./........-...................................\......-......................................-.....-.
.....\..-\-....\........................|........../.......|.........-.............................///........
./.............\........./.................|.....................|..\.........../...|...|..\.|............-...
.................................\.................................\...........................-.........-....
...................\....|...............|...............\..../.....-.....................................\....
.../.......-.......|...........|.....\..................../......................|../.............\...........
......-....................../..../.....-..............\............./...........-.....\....|...............|.
......-.......-.......|..................\................-...|./.......--............../.......|.-.|.........
-..................\........../..........................-...-.............../..............................|.
............/.........-..../\..-.....\....\........./.........\.........../.........|/.../....................
...................................../.....|..\.............\..........-.......\............../.............|.
..../........./.........................-.......\..|..|.....--|...../.............../..-/./.......|..../|.....
.........\.|...|..|-...................................\../..-.....|....\....................-................
..../..-......|..............\../............./..........-.|......../..........|.\........|..................-
......|.................\..........\|...................-.../.\.........../.|............../................./
.........................\.................................../-./............................-..-.........|...
\...........-................/....-.-....................................../...../..............\.......-\.../
-....................................\.........................../.............................|..............
......................\............\.......\..\.............\.................-....\....-.|...................
.|-.-...../......./............./........|.................../.........-..\........./.\|...........-..........
.......\..............\.....-..........\.|.\...|.........\/..........\......|.\...................-...........
../.-..................../..................|.....-...-....-............................-.-..-../..\..........
.................................-.......|...../.\.................\..../................................-....
.-..|.....|.........-........|....-.........../...........\......-..........................\.................
..-.................../...|..-..|...................../...-...|........................................./|....
.........................-\............................./....................../.......-................|.....
........../.......\.........|...-/........./............./......................../...........-../..\.-\...-..
..........|....\-........\...................-.|....-.........\................../.......\....................
/...-..........\......\.........|.............|...........-....../.|..|..-............................|.......
.........\.|........\......\....|.........................................../........-........................
....\.....|.......\....................................-............|.....-........./..\...\.....-..-.........
.|../...../.......|\......\............../....\..|..-...-..............|-.................................-...
.|.\......./........../........|..\.../|......\....|.........-.|.................-.........|............./..-.
...............-.................|...-../\..../.......-.....|..\./............................................
....-.|.........-........................../...................|...............\........................../...
..|/...-..../../...-........-...-.....................................\.......................................
............../....|.....-\.....-................................../\.....................\....-........-.....
......../.|.................|......|.|.-....|...................../....................................\......
"""


class Direction(Enum):
    NORTH = (-1, 0)
    SOUTH = (1, 0)
    EAST = (0, 1)
    WEST = (0, -1)

class Beam:
    direction: Direction
    position: tuple[int, int]
    
    def __init__(self, direction: Direction, position: tuple[int, int]) -> None:
        self.direction = direction
        self.position = position
    def __repr__(self) -> str:
        return self.position.__repr__() + " " + self.direction.__repr__()
    def key_tuple(self):
        return (self.position, self.direction.value)

def get_grid_bounds(grid: util.Grid):
    bounds = sorted(grid.keys())[-1]
    h, w = bounds
    return (h, w)

def next_position(grid: util.Grid, beam: Beam) -> list[Beam]:
    py, px = beam.position
    dy, dx = beam.direction.value
    next_pos = (py + dy, px + dx)
    if not next_pos in grid:
        return []

    match (grid[next_pos], beam.direction):
        case (".", _):
            return [Beam(beam.direction, next_pos)]

        case ("\\", Direction.EAST):
            return [Beam(Direction.SOUTH, next_pos)]
        case ("\\", Direction.SOUTH):
            return [Beam(Direction.EAST, next_pos)]
        case ("\\", Direction.WEST):
            return [Beam(Direction.NORTH, next_pos)]
        case ("\\", Direction.NORTH):
            return [Beam(Direction.WEST, next_pos)]

        case ("/", Direction.EAST):
            return [Beam(Direction.NORTH, next_pos)]
        case ("/", Direction.NORTH):
            return [Beam(Direction.EAST, next_pos)]
        case ("/", Direction.WEST):
            return [Beam(Direction.SOUTH, next_pos)]
        case ("/", Direction.SOUTH):
            return [Beam(Direction.WEST, next_pos)]

        case ("-", Direction.WEST) | ("-", Direction.EAST) | ("|", Direction.NORTH) | ("|", Direction.SOUTH):
            return [Beam(beam.direction, next_pos)]
        
        case ("-", Direction.NORTH) | ("-", Direction.SOUTH):
            return [Beam(Direction.WEST, next_pos), Beam(Direction.EAST, next_pos)]
        case ("|", Direction.EAST) | ("|", Direction.WEST):
            return [Beam(Direction.NORTH, next_pos), Beam(Direction.SOUTH, next_pos)]

def check_energized(grid: util.Grid, start: Beam):
    queue = [start]
    energized = {}
    while len(queue) > 0:
        beam = queue.pop(0)
        energized[beam.key_tuple()] = energized.get(beam.key_tuple(), 0) + 1
        npos = [n for n in next_position(grid, beam) if not n.key_tuple() in energized]
        queue.extend(npos)
    return energized


def part1():
    lines = util.get_lines(input_str)
    grid = util.lines_to_grid(lines) 
    energized = check_energized(grid, Beam(Direction.EAST, (0, -1)))
    k = list(set([e for e, _ in energized]))
    return len(k) - 1

def part2():
    lines = util.get_lines(input_str)
    grid = util.lines_to_grid(lines)
    h, w = get_grid_bounds(grid)
    max_tiles = 0
    for y in range(0, len(lines)):
        energized = check_energized(grid, Beam(Direction.EAST, (y, -1)))
        points = len(set([e for e, _ in energized])) - 1
        max_tiles = max(points, max_tiles)
        energized = check_energized(grid, Beam(Direction.WEST, (y, w + 1)))
        points = len(set([e for e, _ in energized])) - 1
        max_tiles = max(points, max_tiles)
    for x in range(0, len(lines[0])):
        energized = check_energized(grid, Beam(Direction.SOUTH, (-1, x)))
        points = len(set([e for e, _ in energized])) - 1
        max_tiles = max(points, max_tiles)
        energized = check_energized(grid, Beam(Direction.NORTH, (h + 1, x)))
        points = len(set([e for e, _ in energized])) - 1
        max_tiles = max(points, max_tiles)
    return max_tiles

print("Part 1", part1())
print("Part 2", part2())
